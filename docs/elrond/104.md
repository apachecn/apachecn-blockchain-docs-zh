# å¯é‡ç°çš„æ„å»º

> åŸæ–‡ï¼š<https://docs.elrond.com/developers/reproducible-contract-builds>

 é€šè¿‡åˆ©ç”¨ Docker å’Œ DockerHub ä¸Šçš„ä¸€ç»„ [*å†»ç»“* Docker å›¾åƒï¼Œè¯¥é¡µé¢å°†å¼•å¯¼æ‚¨å®Œæˆæ”¯æŒ](https://hub.docker.com/r/elrondnetwork/build-contract-rust/tags)[å¯å¤åˆ¶åˆåŒæ„å»º](https://en.wikipedia.org/wiki/Reproducible_builds)çš„è¿‡ç¨‹ã€‚

æ‚¨è¿˜å°†å­¦ä¹ å¦‚ä½•é‡ç°ä¸€ä¸ªå¥‘çº¦æ„å»ºï¼Œç»™å‡ºå®ƒçš„æºä»£ç å’Œä¸€ä¸ª*å†»ç»“çš„* Docker æ˜ åƒçš„åç§°(æ ‡ç­¾),è¯¥æ˜ åƒç”¨äºå®ƒçš„å‰ä¸€ä¸ªæ„å»º(æˆ‘ä»¬æƒ³è¦é‡ç°)ã€‚

> **å¯å¤åˆ¶æ„å»º**ï¼Œä¹Ÿç§°ä¸º**ç¡®å®šæ€§ç¼–è¯‘**ï¼Œæ˜¯ä¸€ä¸ªç¼–è¯‘è½¯ä»¶çš„è¿‡ç¨‹ï¼Œç¡®ä¿ç”Ÿæˆçš„äºŒè¿›åˆ¶ä»£ç å¯ä»¥è¢«å¤åˆ¶ã€‚ä½¿ç”¨ç¡®å®šæ€§ç¼–è¯‘ç¼–è¯‘çš„æºä»£ç å°†æ€»æ˜¯è¾“å‡ºç›¸åŒçš„äºŒè¿›åˆ¶[ã€ç»´åŸºç™¾ç§‘ã€‘](https://en.wikipedia.org/wiki/Reproducible_builds)ã€‚

##### é‡è¦

æˆªè‡³ 2022 å¹´ 9 æœˆï¼ŒRust å·¥å…·é“¾ä¸æ”¯æŒå¼€ç®±å³ç”¨çš„å¯å†ç°æ„å»ºï¼Œå› æ­¤æˆ‘ä»¬å»ºè®®æ™ºèƒ½åˆçº¦å¼€å‘äººå‘˜éµå¾ªæœ¬æ•™ç¨‹ï¼Œä»¥å®ç°ç¡®å®šæ€§ç¼–è¯‘ã€‚

## æ™ºèƒ½åˆçº¦`codehash`

åœ¨æ·±å…¥å¥‘çº¦æ„å»ºå¯å†ç°æ€§ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£ä¸€ä¸‹`codehash`çš„æ¦‚å¿µã€‚

å½“éƒ¨ç½²æ™ºèƒ½å¥‘çº¦æ—¶ï¼Œç½‘ç»œå­˜å‚¨å­—èŠ‚ç ï¼Œå¹¶è®¡ç®—å…¶`blake2b`æ ¡éªŒå’Œ(ä½¿ç”¨ 256 ä½çš„æ‘˜è¦é•¿åº¦)ã€‚è¿™è¢«ç§°ä¸º`codehash`ã€‚

å‡è®¾æˆ‘ä»¬å¯¹ä¸‹é¢çš„åˆåŒæ„Ÿå…´è¶£ï¼Œéƒ¨ç½²åœ¨*devnet*:[er D1 qqqqqqqqqpgqahertgz 4020 wegswus 8m 7 F2 AK 8 a 6d 0 gv 396 qw3t 2 zy](https://devnet-explorer.elrond.com/accounts/erd1qqqqqqqqqqqqqpgqahertgz4020wegswus8m7f2ak8a6d0gv396qw3t2zy)ã€‚å®ƒçš„æºä»£ç å…¬å¸ƒåœ¨ [GitHub](https://github.com/ElrondNetwork/reproducible-contract-build-example) ä¸Šã€‚

æˆ‘ä»¬å¯ä»¥ä» API ä¸­è·å–å¥‘çº¦çš„ *codehash* :

```rust
curl -s https://devnet-api.elrond.com/accounts/erd1qqqqqqqqqqqqqpgqahertgz4020wegswus8m7f2ak8a6d0gv396qw3t2zy \
| jq -r -j .codeHash \
| base64 -d \
| xxd -p \
| tr -d '\n' 
```

è¾“å‡ºæ˜¯:

```rust
58c6e78f40bd6ccc30d8a01f952b34a13ebfdad796a2526678be17c5d7820174 
```

å¦‚æœ`WASM`æ–‡ä»¶æ˜¯ç›´æ¥å¯ç”¨çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å®ç”¨ç¨‹åº`b2sum`æ¥æœ¬åœ°è®¡ç®—*ä»£ç å“ˆå¸Œ*:

```rust
b2sum -l 256 adder.wasm 
```

è¾“å‡ºå°†æ˜¯ç›¸åŒçš„:

```rust
58c6e78f40bd6ccc30d8a01f952b34a13ebfdad796a2526678be17c5d7820174 
```

æ€»è€Œè¨€ä¹‹ï¼Œä¸ºäº†éªŒè¯å¥‘çº¦çš„ä¸¤ä¸ªç»™å®šæ„å»ºçš„å­—èŠ‚ç ç›¸ç­‰æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æ¯”è¾ƒ *codehash* å±æ€§ã€‚

## æ”¯æŒå¯é‡ç°æ„å»º

æˆªè‡³ 2022 å¹´ 10 æœˆï¼Œä¸ºæ‚¨çš„æ™ºèƒ½åˆçº¦æ”¯æŒå¯å¤åˆ¶æ„å»ºçš„æ¨èæ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ„å»ºè„šæœ¬ï¼Œè¯¥è„šæœ¬ä¾èµ–äºä¸€ä¸ªç‰¹åˆ«è®¾è®¡çš„ã€[å…¬å¼€å¯ç”¨çš„ã€å¸¦æ ‡ç­¾çš„ Docker æ˜ åƒ](https://hub.docker.com/r/elrondnetwork/build-contract-rust/tags)ï¼Œå…¶ä¸­åŒ…æ‹¬å¸¦æ ‡ç­¾çš„ã€æ˜¾å¼ç‰ˆæœ¬çš„æ„å»ºå·¥å…·( *Rust* ã€ *wasm-opt* ç­‰)ã€‚).

å»ºè®®é‡‡ç”¨è¿™ç§æ–¹æ³•ï¼Œä»¥æŠµæ¶ˆä¸`cargo`(é˜²é”ˆå·¥å…·é“¾çš„åŸºæœ¬ç»„ä»¶)å¯¹ç¯å¢ƒçš„æ•æ„Ÿæ€§ç›¸å…³çš„æœ€ç»ˆéç¡®å®šæ€§ã€‚

##### é‡è¦

å¦‚æœæ‚¨çš„æ™ºèƒ½åˆçº¦çš„ä»£ç æºæ‰˜ç®¡åœ¨ GitHub ä¸Šï¼Œé‚£ä¹ˆå®šä¹‰ä¸€ä¸ªç±»ä¼¼äº[è¿™ä¸ª](https://github.com/ElrondNetwork/reproducible-contract-build-example/blob/main/.github/workflows/release-create.yml)çš„ GitHub å·¥ä½œæµæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µï¼Œå®ƒåœ¨*å‘å¸ƒ*è¿‡ç¨‹ä¸­æ‰§è¡Œéƒ¨ç½²(ç”Ÿäº§å°±ç»ª)æ„å»ºã€‚

### é€‰æ‹©ä¸€ä¸ªå›¾åƒæ ‡ç­¾

æ”¯æŒå¯å†ç°æ„å»ºçš„ç¬¬ä¸€æ­¥æ˜¯å†³å®šä½¿ç”¨ç‰¹å®šçš„ Docker å›¾åƒæ ‡ç­¾ã€‚æ£€æŸ¥[elrond network/build-contract-rust](https://hub.docker.com/r/elrondnetwork/build-contract-rust/tags)ä¸Šåˆ—å‡ºçš„**å†»ç»“**æ ‡ç­¾ï¼Œæ£€æŸ¥å®ƒä»¬çš„æ ‡ç­¾â€”â€”ç‰¹åˆ«æ˜¯æ ‡ç­¾`rust`å’Œ`wasm-opt-binaryen`:

```rust
LABEL rust=nightly-2022-08-23
LABEL wasm-opt-binaryen=version_105 
```

å¯¹äºå°šæœªå‘å¸ƒ(éƒ¨ç½²åœ¨ç½‘ç»œä¸Š)çš„æ–°æ™ºèƒ½åˆçº¦ï¼Œå»ºè®®é€‰æ‹©å…·æœ‰**æœ€å¤§ç´¢å¼•å·**çš„æ ‡ç­¾ï¼Œå®ƒé€šå¸¸åŒ…æ‹¬`rust`çš„æœ€æ–°ç‰ˆæœ¬å’Œå…¶ä»–å¿…è¦çš„ä¾èµ–é¡¹ã€‚

ç„¶è€Œï¼Œå¯¹äºè¾ƒå°çš„ç‰ˆæœ¬æˆ–è¡¥ä¸ï¼ŒåšæŒä½¿ç”¨ä¹‹å‰é€‰æ‹©çš„ image æ ‡è®°æ˜¯æ˜æ™ºçš„ï¼Œå‡ºäºåŒæ ·çš„(ç»†å¾®çš„)åŸå› ï¼Œæ‚¨ä¸ä¼šåœ¨ä¿®å¤å…³é”® bug çš„è¿‡ç¨‹ä¸­æ‹¥æŠ±å¼€å‘å·¥å…·çš„æ›´æ–°(åœ¨ä»»ä½•å¼€å‘ç¯å¢ƒä¸­)ã€‚

æ‰€é€‰æ‹©çš„ã€*å†»ç»“çš„*å›¾åƒæ ‡ç­¾åº”ä¼´éšç‰ˆæœ¬åŒ–çš„æºä»£ç (ä¾‹å¦‚ï¼Œé€šè¿‡*å‘å¸ƒè¯´æ˜*)ï¼Œä»¥ä¾¿å‘ŠçŸ¥å…¶ä»–äººå¦‚ä½•å†ç°ç‰¹å®šçš„æ„å»º(ç‰¹å®šæºä»£ç ç‰ˆæœ¬)ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ*å†»ç»“*å›¾åƒæ ‡ç­¾æŒ‡çš„æ˜¯ Docker å›¾åƒæ ‡ç­¾ï¼Œå®ƒåœ¨é¦–æ¬¡å‘å¸ƒåå°†ä¸ä¼šå¾—åˆ°ä»»ä½•æ›´æ–°ã€‚

##### æç¤º

åœ¨ä½ çš„åˆåŒçš„æ¯ä¸ª(ä¸»è¦)ç‰ˆæœ¬ä¸Šåˆ‡æ¢åˆ°ä¸€ä¸ªæ›´æ–°çš„å›¾åƒæ ‡ç­¾æ˜¯å®Œå…¨æ­£å¸¸çš„ã€‚è¯·ç¡®ä¿æ‚¨ä¼ æ’­äº†è¿™äº›ä¿¡æ¯â€”â€”å³ä½¿ç”¨*å‘è¡Œè¯´æ˜*ã€‚

##### è­¦å‘Š

æ°¸è¿œä¸è¦ä¸ºç”Ÿäº§å°±ç»ªçš„æ„å»ºé€‰æ‹©åä¸º`latest`çš„æ ‡ç­¾ã€‚

## é€šè¿‡ Docker æ„å»º(å¯é‡å¤æ„å»º)

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•è¿è¡Œä¸€ä¸ªå¯é‡ç°çš„æ„å»ºï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œå¦‚ä½•åœ¨æœ¬åœ°æœºå™¨ä¸Šä½¿ç”¨ Docker æ¥é‡ç°ä¸€ä¸ªå…ˆå‰çš„æ„å»º(ç”±æ‚¨æˆ–å…¶ä»–äººåœ¨è¿‡å»åˆ›å»ºçš„)ï¼Œè€Œä¸éœ€è¦å®‰è£…å…¶ä»–å·¥å…·ï¼Œä¾‹å¦‚ *erdpy* (åŠå…¶ä¾èµ–é¡¹)ã€‚

### è·å–æºä»£ç 

è®©æˆ‘ä»¬åœ¨æœ¬åœ°å…‹éš†[ç¤ºä¾‹æºä»£ç ](https://github.com/ElrondNetwork/reproducible-contract-build-example)ï¼Œå¹¶åˆ‡æ¢åˆ°[æˆ‘ä»¬æƒ³è¦æ„å»ºçš„æŸä¸ªç‰ˆæœ¬](https://github.com/ElrondNetwork/reproducible-contract-build-example/releases/tag/v0.1.4):

```rust
mkdir -p ~/contracts && cd ~/contracts
git clone https://github.com/ElrondNetwork/reproducible-contract-build-example.git --branch=v0.1.4 --depth=1 
```

é€šè¿‡æŸ¥çœ‹å‘è¡Œè¯´æ˜ï¼Œæˆ‘ä»¬çœ‹åˆ° [`v0.1.4`](https://github.com/ElrondNetwork/reproducible-contract-build-example/releases/tag/v0.1.4) æ˜¯ä½¿ç”¨`image:tag = elrondnetwork/build-contract-rust:v2.0.0`æ„å»ºçš„ã€‚

### ä¸‹è½½æ„å»ºåŒ…è£…

æ„å»ºè¿‡ç¨‹(é€šè¿‡ Docker)è¢«åŒ…è£…åœ¨ä¸€ä¸ªæ˜“äºä½¿ç”¨ã€å‹å¥½çš„ Python è„šæœ¬ä¸­ã€‚è®©æˆ‘ä»¬ä¸‹è½½å®ƒ:

```rust
wget https://raw.githubusercontent.com/ElrondNetwork/elrond-sdk-images-build-contract-rust/main/build_with_docker.py 
```

### å‡†å¤‡ç¯å¢ƒå˜é‡

å¯¼å‡ºä»¥ä¸‹å˜é‡:

```rust
export PROJECT=~/contracts/reproducible-contract-build-example
export BUILD_OUTPUT=~/contracts/output-from-docker
export IMAGE=elrondnetwork/build-contract-rust:v2.0.0 
```

åé¢çš„å¯¼å‡ºè¯­å¥æ˜ç¡®åœ°é€‰æ‹©äº†è¦ä½¿ç”¨çš„**ã€å†»ç»“çš„*Docker å›¾åƒæ ‡ç­¾****ã€‚*

 *### æ‰§è¡Œæ„å»º

ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡è°ƒç”¨ä¹‹å‰ä¸‹è½½çš„æ„å»ºåŒ…è£…å™¨æ¥æ„å»ºå¥‘çº¦:

```rust
python3 ./build_contract_rust_with_docker.py --image=${IMAGE} \
    --project=${PROJECT} \
    --output=${BUILD_OUTPUT} 
```

åœ¨`output`æ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–‡ä»¶(ç¤ºä¾‹):

*   `adder.wasm`:æ™ºèƒ½åˆçº¦çš„å®é™…å­—èŠ‚ç ï¼Œå°†è¢«éƒ¨ç½²åœ¨ç½‘ç»œä¸Šï¼›
*   `adder.abi.json`:æ™ºèƒ½å¥‘çº¦çš„ ABI(ç«¯ç‚¹å’Œç±»å‹å®šä¹‰çš„åˆ—è¡¨)ï¼Œåœ¨å¼€å‘ dApps æˆ–ç®€å•åœ°ä¸å¥‘çº¦äº¤äº’æ—¶ä½¿ç”¨(ä¾‹å¦‚ï¼Œä½¿ç”¨*erdjs*)ï¼›
*   `adder.codehash.txt`:åŒ…å«åˆåŒè®¡ç®—çš„`codehash`çš„æ–‡ä»¶ã€‚
*   `adder.wat`:å­—èŠ‚ç çš„æ–‡æœ¬è¡¨ç¤ºï¼Œå¦‚æœ‰å¿…è¦ï¼Œå°†åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºï¼›
*   `adder.imports.json`:åˆåŒå¯¼å…¥ä½¿ç”¨çš„ VM API å‡½æ•°åˆ—è¡¨ã€‚
*   `adder-v1.2.3.zip`:åŒ…å«ç”¨ä½œæ„å»ºè¾“å…¥çš„æºä»£ç çš„ç‰ˆæœ¬åŒ–æ¡£æ¡ˆã€‚

### TLï¼›ç¾éš¾æ¢å¤æ„å»ºç‰‡æ®µ

è¯è™½å¦‚æ­¤ï¼Œè®©æˆ‘ä»¬å°†ä¸Šè¿°æ­¥éª¤æ€»ç»“æˆä¸€ä¸ª bash ç‰‡æ®µ:

```rust
wget https://raw.githubusercontent.com/ElrondNetwork/elrond-sdk-images-build-contract-rust/main/build_with_docker.py

export PROJECT=~/contracts/reproducible-contract-build-example
export BUILD_OUTPUT=~/contracts/output-from-docker
export IMAGE=elrondnetwork/build-contract-rust:v2.0.0

python3 ./build_contract_rust_with_docker.py --image=${IMAGE} \
    --project=${PROJECT} \
    --output=${BUILD_OUTPUT} 
```

### æ¯”è¾ƒä»£ç å“ˆå¸Œ

ä¸€æ—¦æ„å»ºå°±ç»ªï¼Œæ‚¨å°±å¯ä»¥é€šè¿‡æ£€æŸ¥æ–‡ä»¶`*.codehash.txt`æ¥æ£€æŸ¥ç”Ÿæˆçš„`*.wasm`çš„ codehash

å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œåº”è¯¥æ˜¯:

```rust
adder.codehash.txt: 58c6e78f40bd6ccc30d8a01f952b34a13ebfdad796a2526678be17c5d7820174 
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¸ä¹‹å‰è·å–(æˆ–è®¡ç®—)çš„ codehash ç›¸åŒ¹é…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œéƒ¨ç½²åœ¨[erd1 qqqqqqqqqqpgqahertgz 4020 wegswus 8m 7 F2 AK 8 a 6d 0 gv 396 qw3t 2 zy](https://devnet-explorer.elrond.com/accounts/erd1qqqqqqqqqqqqqpgqahertgz4020wegswus8m7f2ak8a6d0gv396qw3t2zy)çš„å¥‘çº¦ä¿è¯æ˜¯ä»ä¸æˆ‘ä»¬ç­¾å‡ºçš„æºä»£ç ç‰ˆæœ¬ç›¸åŒçš„æºä»£ç ç‰ˆæœ¬æ„å»ºçš„ã€‚

**æ­å–œä½ ï¼**æ‚¨å·²ç»å®Œæˆäº†å¯é‡å¤çš„åˆåŒæ„å»ºğŸ‰*